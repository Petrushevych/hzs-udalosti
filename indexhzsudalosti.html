<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>OOP Hl√≠dky FIVEPD</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
/* Z√°kladn√≠ nastaven√≠ */
body {
  margin: 0;
  font-family: Arial, sans-serif;
}

/* Mapa vlevo ‚Äî z√∫≈æen√° kv≈Øli ≈°ir≈°√≠mu panelu */
#map {
  position: absolute;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: 0;
}


/* Panel hl√≠dek vpravo ‚Äî ≈°ir≈°√≠, ale velikost textu z≈Øst√°v√° */
#hlidky-panel {
  position: fixed;
  top: 80px;
  right: 35px; /* odsazen√≠ od prav√©ho kraje */
  background: rgba(255, 255, 255, 0.85);
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  z-index: 1001;
  font-size: 1em;
  width: 430px;
}

/* Tabulka hl√≠dek ‚Äî ≈°√≠≈ôka bunƒõk se p≈ôizp≈Øsob√≠ panelu */
#hlidky-tabulka {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 1em; /* p≈Øvodn√≠ velikost */
}

#hlidky-tabulka th,
#hlidky-tabulka td {
  border: 1px solid #ccc;
  padding: 8px; /* p≈Øvodn√≠ v√Ω≈°ka bunƒõk */
  text-align: center;
}

#hlidky-tabulka th {
  background-color: #eee;
  font-weight: bold;
}

.hlidky-small td, .hlidky-small th {
  font-size: 0.85em;
  padding: 6px;
}

.hlidky-smaller td, .hlidky-smaller th {
  font-size: 0.75em;
  padding: 4px;
}

.hlidky-tiny td, .hlidky-tiny th {
  font-size: 0.65em;
  padding: 3px;
}


/* Editor barvy */
.barva-editor select {
  width: 100%;
  padding: 4px;
  font-size: 1em;
}

/* Tlaƒç√≠tko spr√°vce */
#admin-controls button {
  width: 100%;
  padding: 10px;
  background-color: #1976d2;
  color: white;
  border: none;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
}

/* Barvy hl√≠dek */
.modra    { background-color: #1565c0; color: white; }
.cervena  { background-color: #c62828; color: white; }
.zluta    { background-color: #fdd835; color: black; }
.fialova  { background-color: #6a1b9a; color: white; }
.zelena { background-color: #2e7d32; color: white; }
.oranzova { background-color: #fb8c00; color: black; }
.ruzova { background-color: #ec407a; color: white; }

/* Heslo box */
#heslo-box {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  background: white;
  padding: 10px;
  border: 1px solid #ccc;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  font-size: 1em;
}

.akce-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

.akce-box input[type="password"] {
  padding: 6px 10px;
  font-size: 1em;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 100px;
}

.akce-box button {
  padding: 6px 12px;
  font-size: 1em;
  background-color: #1976d2;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.akce-box button:hover {
  background-color: #1259a5;
}

.reset-btn {
  background-color: #d32f2f;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.reset-btn:hover {
  background-color: #b71c1c;
}

.teritorium-info {
  font-size: 0.85em;
  font-weight: bold;
  color: #fff; /* b√≠l√© p√≠smo */
  background-color: rgba(0, 0, 0, 0.3); /* tmav√Ω pr≈Øhledn√Ω podklad */
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
  margin-top: 4px;
}

.teritorium-editor select {
  margin-top: 6px;
  font-size: 0.9em;
  padding: 4px;
  width: 100%;
}

#vozidla-panel {
  position: fixed;
  top: 80px;
  left: 50px;
  background: rgba(255, 255, 255, 0.85);
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
  z-index: 1001;
  font-size: 1em;
  width: 300px;
}

#vozidla-tabulka {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 1em;
}

#vozidla-tabulka td {
  padding: 8px;
  text-align: center;
  font-weight: bold;
  color: white;
}

#heslo-box {
  position: fixed;
  top: 20px;
  left: 50px;
  z-index: 1000;
  background: white;
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  font-size: 0.9em;
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: 'Montserrat', sans-serif; /* nov√Ω font */
}



#heslo-box input[type="password"] {
  padding: 4px 8px;
  font-size: 0.9em;
  border: 1px solid #ccc;
  border-radius: 4px;
  width: 120px;
}

#heslo-box button {
  padding: 4px 10px;
  font-size: 0.9em;
  background-color: #1976d2;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
}

#heslo-box button:hover {
  background-color: #1259a5;
}

/* Popup zpr√°vy */
#popup-msg {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 20px 30px;
  font-size: 1.1em;
  font-weight: bold;
  border-radius: 8px;
  z-index: 2000;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  text-align: center;
  animation: fadein 0.3s ease;
  display: none;
}

.popup-error   { background-color: #c62828; color: white; }
.popup-success { background-color: #2e7d32; color: white; }

@keyframes fadein {
  from { opacity: 0; }
  to   { opacity: 1; }
}
  </style>
</head>
<body>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@500&display=swap" rel="stylesheet">

  <div id="heslo-box">
    <label>Zadej heslo nejlep≈°√≠ho spr√°vce:</label>
    <input type="password" id="heslo">
    <button onclick="overitHeslo()">Odemknout</button>
  </div>

<div id="vozidla-panel">
  <h2>üöó Vozidla dle teritoria</h2>
  <table id="vozidla-tabulka">
    <tr class="modra"><td><div class="teritorium-info">T-1 ‚Äì ≈†koda Kodiaq FL / ≈†koda Scala </div></td></tr>
    <tr class="zluta"><td><div class="teritorium-info">T-2 ‚Äì ≈†koda Octavia 3 / ≈†koda Scala</div></td></tr>
    <tr class="fialova"><td><div class="teritorium-info">T-3 ‚Äì ≈†koda Octavia 2 / ≈†koda Kodiaq FL</div></td></tr>
    <tr class="zelena"><td><div class="teritorium-info">T-4 ‚Äì ≈†koda Kodiaq FL </div></td></tr>
    <tr class="oranzova"><td><div class="teritorium-info">T-5 ‚Äì Hyundai IX35</div></td></tr>
    <tr class="ruzova"><td><div class="teritorium-info">T-6 ‚Äì ≈†koda Scala</div></td></tr>
    <tr class="cervena"><td><div class="teritorium-info">Velitel ‚Äì ≈†koda Kodiaq FL Velitel√°k</div></td></tr>
  </table>
</div>


  <div id="map"></div>
    <div id="hlidky-panel">
    <h2>üëÆ Hl√≠dky OOP</h2>
    <table id="hlidky-tabulka">
      <thead>
<thead>
  <tr>
    <th>Volac√≠ znak</th>
    <th class="barva-editor" style="display:none;">Barva</th>
    <th>Stav slu≈æby</th>
    <th>P≈ôihl√°≈°en√≠ do slu≈æby</th>
  </tr>
</thead>
      </thead>
      <tbody></tbody>
    </table>

    <div id="admin-controls" style="display:none; margin-top:10px;">
      <button onclick="ulozitAOdhlasit()">üíæ Ulo≈æit a odhl√°sit</button>
    </div>
  </div>
  <div id="popup-msg"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCTmQI32kkdzPKOV_arZ4OVrcuvMBfzBMM",
      authDomain: "oophlidky.firebaseapp.com",
      databaseURL: "https://oophlidky-default-rtdb.firebaseio.com",
      projectId: "oophlidky",
      storageBucket: "oophlidky.firebasestorage.app",
      messagingSenderId: "103016091145",
      appId: "1:103016091145:web:09c790383f5d2854b0f2d8"
    };

    firebase.initializeApp(firebaseConfig);

firebase.auth().signInAnonymously()
  .then(() => console.log('‚úÖ Firebase: anonymn√≠ p≈ôihl√°≈°en√≠ OK'))
  .catch(e => {
    console.error('‚ùå Firebase auth error:', e);
    // Pokud je spr√°vce p≈ôihl√°≈°en, zobraz√≠me popup, jinak jen logujeme
    if (prihlaseny) {
      zobrazPopup('‚õî Nelze se p≈ôihl√°sit do Firebase. Zkontroluj pravidla DB nebo Auth.', 'error');
    }
  });


    const db = firebase.database();
  </script>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let prihlaseny = false;

const barvaNaTeritorium = {
  modra: "T-1",
  zluta: "T-2",
  fialova: "T-3",
  zelena: "T-4",
  oranzova: "T-5",
  ruzova: "T-6",
  cervena: "Velitel"
};

function overitHeslo() {
  const heslo = document.getElementById("heslo").value;
  if (heslo === "OOPFIVEPDVEL254") {
    prihlaseny = true;
    document.getElementById("heslo-box").style.display = "none";
    document.querySelectorAll(".barva-editor").forEach(el => el.style.display = "table-cell");
    document.querySelectorAll(".teritorium-editor").forEach(el => el.style.display = "table-cell");
    document.getElementById("admin-controls").style.display = "block";
    zobrazPopup("‚úÖ P≈ôihl√°≈°en√≠ spr√°vce aktivov√°no", "success");

    // üí• Znovu naƒçti tabulku, aby se zobrazil panel Reset
    zobrazitHlidky(); // nebo jin√° tvoje funkce, kter√° generuje tabulku
  } else {
    zobrazPopup("‚õî ≈†patn√© heslo", "error");
  }
}

function resetSluzby(znak) {
  db.ref(`sluzby/${znak}`).remove()
    .then(() => {
      zobrazPopup(`üßπ ƒåas slu≈æby pro ${znak} byl vymaz√°n`, "success");
    })
    .catch(err => {
      console.error("Chyba p≈ôi maz√°n√≠ slu≈æby:", err);
      zobrazPopup("‚õî Chyba p≈ôi maz√°n√≠ slu≈æby", "error");
    });
}

function zmenBarvu(select, znak) {
  const novaBarva = select.value;
  const tr = select.closest("tr");

  // üîÑ Zmƒõ≈à barvu ≈ô√°dku
  tr.className = novaBarva;
  db.ref("hlidky/" + znak + "/barva").set(novaBarva);

  // üí• Automatick√© teritorium
  const autoTeritorium = barvaNaTeritorium[novaBarva];
  if (autoTeritorium) {
    db.ref("hlidky/" + znak + "/teritorium").set(autoTeritorium);
    const infoDiv = tr.querySelector(".teritorium-info");
    if (infoDiv) infoDiv.textContent = autoTeritorium;
  }

  // üîÅ Vynutit aktualizaci stavu slu≈æby u v≈°ech klient≈Ø
  db.ref("sluzby/" + znak + "/refresh").set(Date.now());
}



function aktualizujStavSluzby(znak) {
  db.ref("sluzby/" + znak).once("value").then(snap => {
    const sluzba = snap.val() || {};
    const veSluzbe = Boolean(sluzba.start && !sluzba.end);
    let stavText = veSluzbe ? "üü¢ Ve slu≈æbƒõ" : "üî¥ Mimo slu≈æbu";

    if (sluzba.start) {
      const startTime = new Date(sluzba.start);
      const endTime = sluzba.end ? new Date(sluzba.end) : new Date();
      const minuty = Math.round((endTime - startTime) / 60000);
      if (minuty >= 60) {
        const hodiny = Math.floor(minuty / 60);
        const zbytekMinut = minuty % 60;
        stavText += ` ‚è± ${hodiny}h ${zbytekMinut}min`;
      } else {
        stavText += ` ‚è± ${minuty} min`;
      }
    }

    const stavTd = document.getElementById(`stav-${znak}`);
    if (stavTd) stavTd.textContent = stavText;
  });
}

    function ulozitAOdhlasit() {
      zobrazPopup("‚úÖ Zmƒõny ulo≈æeny. Odhl√°≈°eno.", "success");
      location.reload();
    }

function prihlasit(znak) {
  const hesloInput = document.getElementById("heslo-" + znak);
  const heslo = hesloInput ? hesloInput.value : "";

  db.ref("hesla/" + znak).once("value")
    .then(snap => {
      const real = snap.val();
      if (real === null) {
        zobrazPopup("‚õî Heslo pro tuto volaƒçku nen√≠ nastaveno", "error");
        return;
      }
      if (real === heslo) {
        const sluzbaRef = db.ref("sluzby/" + znak);

        sluzbaRef.once("value").then(snap => {
          const data = snap.val() || {};
          const updates = {};

          // ‚úÖ Zapi≈° start jen pokud je≈°tƒõ neexistuje
          if (!data.start) {
            updates.start = new Date().toISOString();
          }

          // ‚úÖ V≈ædy sma≈æ end, aby se slu≈æba znovu aktivovala
          updates.end = null;

          sluzbaRef.update(updates)
            .then(() => zobrazPopup(`‚úÖ ${znak} p≈ôihl√°≈°en do slu≈æby`, "success"))
            .catch(err => {
              console.error("Chyba p≈ôi z√°pisu sluzby:", err);
              zobrazPopup("‚õî Chyba z√°pisu do datab√°ze", "error");
            });
        });
      } else {
        zobrazPopup("‚õî ≈†patn√© heslo", "error");
      }
    })
    .catch(err => {
      console.error("Chyba p≈ôi ƒçten√≠ hesla:", err);
      zobrazPopup(err && err.code === "PERMISSION_DENIED"
        ? "‚õî P≈ô√≠stup k hesl≈Øm omezen. Zkontroluj pravidla DB"
        : "‚õî Chyba p≈ôi ovƒõ≈ôov√°n√≠ hesla", "error");
    });
}


    function odhlasit(znak) {
      const hesloInput = document.getElementById("heslo-" + znak);
      const heslo = hesloInput ? hesloInput.value : "";

      db.ref("hesla/" + znak).once("value")
        .then(snap => {
          const real = snap.val();
          if (real === null) {
            zobrazPopup("‚õî Heslo pro tuto volaƒçku nen√≠ nastaveno", "error");
            return;
          }
          if (real === heslo) {
            const cas = new Date().toISOString();
            db.ref("sluzby/" + znak + "/end").set(cas)
              .then(() => zobrazPopup(`‚úÖ ${znak} odhl√°≈°en ze slu≈æby`, "success"))
              .catch(err => {
                console.error("Chyba p≈ôi z√°pisu konce slu≈æby:", err);
                zobrazPopup("‚õî Chyba z√°pisu do datab√°ze", "error");
              });
          } else {
            zobrazPopup("‚õî ≈†patn√© heslo", "error");
          }
        })
        .catch(err => {
          console.error("Chyba p≈ôi ƒçten√≠ hesla:", err);
          zobrazPopup(err && err.code === "PERMISSION_DENIED"
            ? "‚õî P≈ô√≠stup k hesl≈Øm omezen. Zkontroluj pravidla DB"
            : "‚õî Chyba p≈ôi ovƒõ≈ôov√°n√≠ hesla", "error");
        });
    }


    function zobrazPopup(text, typ) {
      const popup = document.getElementById("popup-msg");
      popup.innerText = text;
      popup.className = typ === "error" ? "popup-error" : "popup-success";
      popup.style.display = "block";
      setTimeout(() => { popup.style.display = "none"; }, 3000);
    }

    const map = L.map('map', { crs: L.CRS.Simple, minZoom: 0, maxZoom: 3, zoomControl: true });
    const bounds = [[0,0], [1000,1000]];
    const image = L.imageOverlay('mapa.png', bounds).addTo(map);
    map.fitBounds(bounds);

    console.log("Naƒç√≠t√°m hl√≠dky z Firebase...");

db.ref("hlidky").on("value", snapshot => {
  const data = snapshot.val();
  const tbody = document.querySelector("#hlidky-tabulka tbody");
  tbody.innerHTML = "";

  if (!data) {
    tbody.innerHTML = '<tr><td colspan="5">≈Ω√°dn√© hl√≠dky v datab√°zi</td></tr>';
    return;
  }

  const hlidkyPole = Object.entries(data).sort(([znakA, a], [znakB, b]) => {
    const getTeritoriumIndex = t => {
      if (t === "Velitel") return -1;
      const num = parseInt((t || "").replace("T-", ""));
      return isNaN(num) ? 999 : num;
    };

    const ta = getTeritoriumIndex(a.teritorium);
    const tb = getTeritoriumIndex(b.teritorium);

    if (ta !== tb) return ta - tb;

    const na = parseInt(znakA.replace(/\D/g, "") || 999);
    const nb = parseInt(znakB.replace(/\D/g, "") || 999);
    return na - nb;
  });

  for (const [znak, { barva, teritorium }] of hlidkyPole) {
    const tr = document.createElement("tr");
    tr.className = barva || "";
    tr.innerHTML = `
      <td>
        ${znak}
        <div class="teritorium-info">${teritorium || "‚Äì"}</div>
      </td>
      <td class="barva-editor" style="display:none;">
        <select onchange="zmenBarvu(this, '${znak}')">
          ${["modra","cervena","zluta","fialova","zelena","oranzova","ruzova"].map(b =>
            `<option value="${b}" ${barva === b ? "selected" : ""}>${b.charAt(0).toUpperCase() + b.slice(1)}</option>`).join("")}
        </select>
      </td>
      <td id="stav-${znak}">Naƒç√≠t√°m‚Ä¶</td>
      <td id="akce-${znak}">
        <div class="akce-box">
          <input type="password" id="heslo-${znak}" placeholder="Heslo">
          <button onclick="prihlasit('${znak}')">P≈ôihl√°sit se</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // üìè Dynamick√© ≈°k√°lov√°n√≠ tabulky podle poƒçtu ≈ô√°dk≈Ø
  const radky = tbody.querySelectorAll("tr").length;
  const tabulka = document.getElementById("hlidky-tabulka");
  tabulka.classList.remove("hlidky-small", "hlidky-smaller", "hlidky-tiny");

  if (radky > 10 && radky <= 14) {
    tabulka.classList.add("hlidky-small");
  } else if (radky > 14 && radky <= 18) {
    tabulka.classList.add("hlidky-smaller");
  } else if (radky > 18) {
    tabulka.classList.add("hlidky-tiny");
  }

  if (prihlaseny) {
    document.querySelectorAll(".barva-editor").forEach(el => el.style.display = "table-cell");
    document.querySelectorAll(".teritorium-editor").forEach(el => el.style.display = "table-cell");
    document.getElementById("admin-controls").style.display = "block";
  }
}, err => {
  console.error('Chyba p≈ôi ƒçten√≠ hlidek (on value):', err);
  const tbody = document.querySelector("#hlidky-tabulka tbody");
  tbody.innerHTML = '<tr><td colspan="4">Chyba p≈ôi naƒç√≠t√°n√≠ hl√≠dek: zkontroluj pravidla DB</td></tr>';
});

db.ref("sluzby").on("value", snapshot => {
  const sluzby = snapshot.val() || {};
  const vsechnyZnaky = Array.from(document.querySelectorAll("#hlidky-tabulka tbody tr"))
    .map(tr => tr.querySelector("td")?.childNodes[0]?.textContent?.trim())
    .filter(Boolean);

  for (const znak of vsechnyZnaky) {
    const sluzba = sluzby[znak] || {};
    const veSluzbe = Boolean(sluzba.start && !sluzba.end);
let stavText = veSluzbe ? "üü¢ Ve slu≈æbƒõ" : "üî¥ Mimo slu≈æbu";

if (sluzba.start) {
  const startTime = new Date(sluzba.start);
  const endTime = sluzba.end ? new Date(sluzba.end) : new Date();
  const minuty = Math.round((endTime - startTime) / 60000);

  if (minuty >= 60) {
    const hodiny = Math.floor(minuty / 60);
    const zbytekMinut = minuty % 60;
    stavText += ` ‚è± ${hodiny}h ${zbytekMinut}min`;
  } else {
    stavText += ` ‚è± ${minuty} min`;
  }
}




    const stavTd = document.getElementById(`stav-${znak}`);
    const akceTd = document.getElementById(`akce-${znak}`);

    if (stavTd) stavTd.textContent = stavText;

if (akceTd) {
  akceTd.innerHTML = `
    <div class="akce-box">
      <input type="password" id="heslo-${znak}" placeholder="Heslo">
      ${veSluzbe
        ? `<button onclick="odhlasit('${znak}')">Odhl√°sit se</button>`
        : `<button onclick="prihlasit('${znak}')">P≈ôihl√°sit se</button>`}
      ${prihlaseny ? `<button class="reset-btn" onclick="resetSluzby('${znak}')">Reset</button>` : ""}
    </div>`;
}



  }
});


  </script>
</body>
</html>
